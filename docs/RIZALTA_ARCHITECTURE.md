# ĞÑ€Ñ…Ğ¸Ñ‚ĞµĞºÑ‚ÑƒÑ€Ğ° RIZALTA

## ĞĞ±Ñ‰Ğ°Ñ ÑÑ…ĞµĞ¼Ğ°
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         PROD                                 â”‚
â”‚  Telegram â†’ Cloudflare Tunnel â†’ :8000 â†’ FastAPI (webhook)   â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                         DEV                                  â”‚
â”‚  Telegram â†’ polling (run_polling.py)                        â”‚
â”‚  Mini App â†’ Cloudflare Tunnel â†’ :8002 â†’ FastAPI (API)       â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                      MINI APP                                â”‚
â”‚  Vercel: rizalta-miniapp.vercel.app                         â”‚
â”‚  /api/* â†’ PROD Ñ‚ÑƒĞ½Ğ½ĞµĞ»ÑŒ                                      â”‚
â”‚  /api-dev/* â†’ DEV Ñ‚ÑƒĞ½Ğ½ĞµĞ»ÑŒ                                   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## Ğ¡Ñ‚Ñ€ÑƒĞºÑ‚ÑƒÑ€Ğ° Ğ¿Ñ€Ğ¾ĞµĞºÑ‚Ğ°
```
/opt/bot-dev/
â”œâ”€â”€ app.py                    # Ğ“Ğ»Ğ°Ğ²Ğ½Ñ‹Ğ¹ Ñ„Ğ°Ğ¹Ğ» (webhook, Ñ€Ğ¾ÑƒÑ‚Ğ¸Ğ½Ğ³, API)
â”œâ”€â”€ run_polling.py            # DEV Ñ€ĞµĞ¶Ğ¸Ğ¼ (polling)
â”œâ”€â”€ config/
â”‚   â””â”€â”€ settings.py           # ĞšĞ¾Ğ½ÑÑ‚Ğ°Ğ½Ñ‚Ñ‹, ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ Ğ¼ĞµĞ½Ñ
â”œâ”€â”€ handlers/
â”‚   â”œâ”€â”€ menu.py               # Ğ“Ğ»Ğ°Ğ²Ğ½Ğ¾Ğµ Ğ¼ĞµĞ½Ñ
â”‚   â”œâ”€â”€ ai_chat.py            # AI Ğ´Ğ¸Ğ°Ğ»Ğ¾Ğ³Ğ¸
â”‚   â”œâ”€â”€ booking.py            # ĞĞ½Ğ»Ğ°Ğ¹Ğ½-Ğ¿Ğ¾ĞºĞ°Ğ·Ñ‹
â”‚   â”œâ”€â”€ booking_calendar.py   # ĞšĞ°Ğ»ĞµĞ½Ğ´Ğ°Ñ€ÑŒ + Ğ³Ñ€ÑƒĞ¿Ğ¿Ğ¾Ğ²Ñ‹Ğµ Ğ·Ğ°ÑĞ²ĞºĞ¸
â”‚   â”œâ”€â”€ kp.py                 # ĞšĞŸ + Ğ½Ğ°Ğ²Ğ¸Ğ³Ğ°Ñ†Ğ¸Ñ + Ğ¿Ğ°Ğ³Ğ¸Ğ½Ğ°Ñ†Ğ¸Ñ
â”‚   â”œâ”€â”€ calc_dynamic.py       # Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹ ROI
â”‚   â”œâ”€â”€ secretary.py          # AI-ÑĞµĞºÑ€ĞµÑ‚Ğ°Ñ€ÑŒ
â”‚   â””â”€â”€ media.py              # ĞœĞµĞ´Ğ¸Ğ°/Ğ¿Ñ€ĞµĞ·ĞµĞ½Ñ‚Ğ°Ñ†Ğ¸Ğ¸
â”œâ”€â”€ services/
â”‚   â”œâ”€â”€ intent_router.py      # GPT Intent Router
â”‚   â”œâ”€â”€ telegram.py           # API Telegram
â”‚   â”œâ”€â”€ notifications.py      # Ğ£Ğ²ĞµĞ´Ğ¾Ğ¼Ğ»ĞµĞ½Ğ¸Ñ
â”‚   â”œâ”€â”€ units_db.py           # Ğ‘Ğ” Ğ»Ğ¾Ñ‚Ğ¾Ğ² (348 Ğ»Ğ¾Ñ‚Ğ¾Ğ²)
â”‚   â”œâ”€â”€ kp_pdf_generator.py   # PDF ĞšĞŸ
â”‚   â”œâ”€â”€ calc_universal.py     # Ğ Ğ°ÑÑ‡Ñ‘Ñ‚Ñ‹ Ñ€Ğ°ÑÑÑ€Ğ¾Ñ‡ĞºĞ¸
â”‚   â””â”€â”€ secretary_db.py       # Ğ‘Ğ” ÑĞµĞºÑ€ĞµÑ‚Ğ°Ñ€Ñ
â”œâ”€â”€ data/
â”‚   â”œâ”€â”€ units.json            # Ğ”Ğ°Ğ½Ğ½Ñ‹Ğµ Ğ»Ğ¾Ñ‚Ğ¾Ğ²
â”‚   â””â”€â”€ rizalta_finance.json  # Ğ¤Ğ¸Ğ½Ğ°Ğ½ÑĞ¾Ğ²Ñ‹Ğµ Ğ´Ğ°Ğ½Ğ½Ñ‹Ğµ
â””â”€â”€ *.db                      # SQLite Ğ±Ğ°Ğ·Ñ‹
```

## Systemd ÑĞµÑ€Ğ²Ğ¸ÑÑ‹
```
PROD:
â”œâ”€â”€ rizalta-bot.service         (uvicorn :8000, webhook)
â””â”€â”€ cloudflare-rizalta.service  (Ñ‚ÑƒĞ½Ğ½ĞµĞ»ÑŒ)

DEV:
â”œâ”€â”€ rizalta-bot-dev.service     (polling)
â”œâ”€â”€ rizalta-dev-api.service     (uvicorn :8002)
â””â”€â”€ rizalta-dev-tunnel.service  (Ñ‚ÑƒĞ½Ğ½ĞµĞ»ÑŒ)
```

## Ğ‘Ğ°Ğ·Ğ° Ğ´Ğ°Ğ½Ğ½Ñ‹Ñ…

### properties.db â€” 348 Ğ»Ğ¾Ñ‚Ğ¾Ğ²
- ĞšĞ¾Ñ€Ğ¿ÑƒÑ 1 Â«FamilyÂ»: 244 Ğ»Ğ¾Ñ‚Ğ°
- ĞšĞ¾Ñ€Ğ¿ÑƒÑ 2 Â«BusinessÂ»: 104 Ğ»Ğ¾Ñ‚Ğ°
- Ğ¢Ğ°Ğ±Ğ»Ğ¸Ñ†Ğ° `bookings`: taken_by_id, taken_by_name, group_message_id

### secretary.db
- `tasks` â€” Ğ·Ğ°Ğ´Ğ°Ñ‡Ğ¸ Ğ¿Ğ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹
- `users` â€” timezone (default: 3 = ĞœĞ¾ÑĞºĞ²Ğ°)

## Mini App

**URL:** https://rizalta-miniapp.vercel.app
- PROD: Ğ±ĞµĞ· Ğ¿Ğ°Ñ€Ğ°Ğ¼ĞµÑ‚Ñ€Ğ¾Ğ² â†’ `/api/*` â†’ PROD Ñ‚ÑƒĞ½Ğ½ĞµĞ»ÑŒ
- DEV: `?env=dev` â†’ `/api-dev/*` â†’ DEV Ñ‚ÑƒĞ½Ğ½ĞµĞ»ÑŒ

**ĞŸĞ¾Ñ‡ĞµĞ¼Ñƒ Vercel proxy:**
- `*.trycloudflare.com` Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ² Ğ Ğ¤
- Vercel.app Ğ½Ğµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ÑÑ

**ĞŸÑ€Ğ¸ ÑĞ¼ĞµĞ½Ğµ URL Ñ‚ÑƒĞ½Ğ½ĞµĞ»Ñ:**
```bash
nano /opt/miniapp/vercel.json
cd /opt/miniapp && vercel --prod
```

## GPT Intent Router

Ğ¤Ğ°Ğ¹Ğ»: `services/intent_router.py`

1. **QUICK_PATTERNS** â€” Ñ‚Ğ¾Ñ‡Ğ½Ñ‹Ğµ ÑĞ¾Ğ²Ğ¿Ğ°Ğ´ĞµĞ½Ğ¸Ñ ĞºĞ½Ğ¾Ğ¿Ğ¾Ğº (Ğ±ĞµĞ· GPT)
2. **Regex Ğ¿Ğ°Ñ‚Ñ‚ĞµÑ€Ğ½Ñ‹** â€” ĞºĞ¾Ğ´Ñ‹ Ğ»Ğ¾Ñ‚Ğ¾Ğ², Ğ±ÑĞ´Ğ¶ĞµÑ‚Ñ‹
3. **GPT ĞºĞ»Ğ°ÑÑĞ¸Ñ„Ğ¸ĞºĞ°Ñ†Ğ¸Ñ** â€” ÑĞ»Ğ¾Ğ¶Ğ½Ñ‹Ğµ Ğ·Ğ°Ğ¿Ñ€Ğ¾ÑÑ‹

ĞŸÑ€Ğ¸Ğ¾Ñ€Ğ¸Ñ‚ĞµÑ‚: ĞºĞ½Ğ¾Ğ¿ĞºĞ¸ â†’ regex â†’ GPT

## ğŸ“ˆ ĞœĞ°ÑÑˆÑ‚Ğ°Ğ±Ğ¸Ñ€Ğ¾Ğ²Ğ°Ğ½Ğ¸Ğµ

### Ğ¢ĞµĞºÑƒÑ‰Ğ¸Ğµ Ğ¼ĞµÑ‚Ñ€Ğ¸ĞºĞ¸ (10.01.2026)
- **ĞŸĞ¾Ğ»ÑŒĞ·Ğ¾Ğ²Ğ°Ñ‚ĞµĞ»ĞµĞ¹:** 13 ÑƒĞ½Ğ¸ĞºĞ°Ğ»ÑŒĞ½Ñ‹Ñ…
- **Ğ—Ğ°Ğ¿Ñ€Ğ¾ÑĞ¾Ğ²:** 282
- **Ğ›Ğ¾Ñ‚Ğ¾Ğ² Ğ² Ğ±Ğ°Ğ·Ğµ:** 345
- **WAL mode:** Ğ²Ñ‹ĞºĞ»ÑÑ‡ĞµĞ½ (delete)

### Ğ›Ğ¸Ğ¼Ğ¸Ñ‚Ñ‹ Ñ‚ĞµĞºÑƒÑ‰ĞµĞ³Ğ¾ ÑÑ‚ĞµĞºĞ°
| ĞšĞ¾Ğ¼Ğ¿Ğ¾Ğ½ĞµĞ½Ñ‚ | Ğ›Ğ¸Ğ¼Ğ¸Ñ‚ | Ğ”ĞµĞ¹ÑÑ‚Ğ²Ğ¸Ğµ Ğ¿Ñ€Ğ¸ Ğ´Ğ¾ÑÑ‚Ğ¸Ğ¶ĞµĞ½Ğ¸Ğ¸ |
|-----------|-------|------------------------|
| SQLite | ~200 Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… | Ğ’ĞºĞ»ÑÑ‡Ğ¸Ñ‚ÑŒ WAL mode |
| SQLite + WAL | ~500 Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… | ĞœĞ¸Ğ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ° Redis |
| Redis | ~2000 Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… | ĞœĞ¸Ğ³Ñ€Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ Ğ½Ğ° PostgreSQL |
| RAM (4GB) | ~500 Ğ°ĞºÑ‚Ğ¸Ğ²Ğ½Ñ‹Ñ… | Ğ£Ğ²ĞµĞ»Ğ¸Ñ‡Ğ¸Ñ‚ÑŒ RAM Ğ¸Ğ»Ğ¸ Ğ¾Ğ¿Ñ‚Ğ¸Ğ¼Ğ¸Ğ·Ğ¸Ñ€Ğ¾Ğ²Ğ°Ñ‚ÑŒ |

### ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ğ° Ğ´Ğ»Ñ Ğ²ĞºĞ»ÑÑ‡ĞµĞ½Ğ¸Ñ WAL
```bash
sqlite3 /opt/bot/properties.db "PRAGMA journal_mode=WAL;"
sqlite3 /opt/bot/secretary.db "PRAGMA journal_mode=WAL;"
sqlite3 /opt/bot/monitoring.db "PRAGMA journal_mode=WAL;"
```

## ğŸŒ Cloudflare Named Tunnels

### ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ÑƒÑ€Ğ°Ñ†Ğ¸Ñ (Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¾ 11.01.2026)

| Ğ¢ÑƒĞ½Ğ½ĞµĞ»ÑŒ | Ğ”Ğ¾Ğ¼ĞµĞ½ | ĞŸĞ¾Ñ€Ñ‚ | ĞšĞ¾Ğ½Ñ„Ğ¸Ğ³ |
|---------|-------|------|--------|
| rizalta-prod | api.rizaltaservice.ru | 8000 | /root/.cloudflared/config.yml |
| rizalta-dev | dev.rizaltaservice.ru | 8002 | /root/.cloudflared/config-dev.yml |

### ĞŸÑ€ĞµĞ¸Ğ¼ÑƒÑ‰ĞµÑÑ‚Ğ²Ğ° Named Tunnel:
- URL ÑÑ‚Ğ°Ñ‚Ğ¸Ñ‡ĞµÑĞºĞ¸Ğ¹ (Ğ½Ğµ Ğ¼ĞµĞ½ÑĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¸ Ğ¿ĞµÑ€ĞµĞ·Ğ°Ğ¿ÑƒÑĞºĞµ)
- ĞĞµ Ğ±Ğ»Ğ¾ĞºĞ¸Ñ€ÑƒĞµÑ‚ÑÑ Ğ¿Ñ€Ğ¾Ğ²Ğ°Ğ¹Ğ´ĞµÑ€Ğ°Ğ¼Ğ¸ Ğ² Ğ Ğ¤
- ĞĞµ Ğ½ÑƒĞ¶Ğ½Ñ‹ ÑĞºÑ€Ğ¸Ğ¿Ñ‚Ñ‹ Ğ°Ğ²Ñ‚Ğ¾Ğ¾Ğ±Ğ½Ğ¾Ğ²Ğ»ĞµĞ½Ğ¸Ñ webhook

### ĞšĞ¾Ğ¼Ğ°Ğ½Ğ´Ñ‹ ÑƒĞ¿Ñ€Ğ°Ğ²Ğ»ĞµĞ½Ğ¸Ñ:
```bash
# Ğ¡Ğ¿Ğ¸ÑĞ¾Ğº Ñ‚ÑƒĞ½Ğ½ĞµĞ»ĞµĞ¹
cloudflared tunnel list

# Ğ›Ğ¾Ğ³Ğ¸
journalctl -u cloudflare-rizalta -f      # PROD
journalctl -u rizalta-dev-tunnel -f      # DEV
```

### Credentials:
- PROD: /root/.cloudflared/2d4a575c-883b-4361-9ee3-b3efe1a0847f.json
- DEV: /root/.cloudflared/f77474f6-e2f6-40b6-bf3c-f23edf03cb72.json
- Cert: /root/.cloudflared/cert.pem
