"""
–û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å —é–Ω–∏—Ç–∞–º–∏:
- –†–∞—Å—á—ë—Ç –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ (ROI)
- –†–∞—Å—Å—Ä–æ—á–∫–∞ –∏ –∏–ø–æ—Ç–µ–∫–∞
- –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏
- –ü–æ–¥–±–æ—Ä –ª–æ—Ç–∞ –ø–æ –±—é–¥–∂–µ—Ç—É
"""

import os
from typing import Dict, Any, Optional, List

from config.settings import RIZALTA_LAYOUTS_DIR, TG_API, MAIN_MENU_BUTTONS
from models.state import (
    set_dialog_state,
    clear_dialog_state,
    get_dialog_state,
    save_budget,
    get_budget,
    save_format,
    get_format,
    DialogStates,
)
from services.telegram import send_message, send_message_inline, send_document
from services.data_loader import load_finance, get_finance_defaults, get_min_lot
from services.calculations import (
    fmt_rub,
    normalize_unit_code,
    get_unit_by_code,
    compute_rent_cashflow,
    format_growth_projection,
    get_entry_ratio,
    suggest_units_for_budget,
    generate_finance_text,
    generate_investment_pdf,
)

import requests


# ====== –ì–æ—Ç–æ–≤—ã–µ —Ç–µ–∫—Å—Ç—ã –¥–ª—è —é–Ω–∏—Ç–æ–≤ ======

# –¢–µ–∫—Å—Ç—ã –¥–ª—è —Ä–∞—Å—á—ë—Ç–∞ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ (—Ñ–æ–∫—É—Å –Ω–∞ –¥–æ—Ö–æ–¥–∞—Ö –∏ –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–∏)
ROI_TEXTS = {
    "A209": """üíé <b>–°—Ç—É–¥–∏—è A209 (24.5 –º¬≤)</b>

<b>–í–∞—à –±–∏–ª–µ—Ç –≤ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏ ‚Äî –∫–æ–º–ø–∞–∫—Ç–Ω—ã–π –∏ –ª–∏–∫–≤–∏–¥–Ω—ã–π –Ω–æ–º–µ—Ä</b>

–ò–¥–µ–∞–ª—å–Ω—ã–π –ª–æ—Ç –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∞–∫—Ç–∏–≤–∞. –°–∞–º—ã–π –Ω–∏–∑–∫–∏–π –ø–æ—Ä–æ–≥ –≤—Ö–æ–¥–∞, –ø—Ä–∏ —ç—Ç–æ–º ‚Äî –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –∑–∞—â–∏—Ç–∞ –∫–∞–ø–∏—Ç–∞–ª–∞.

üìä <b>–î–û–•–û–î–ù–û–°–¢–¨</b>

‚ñ™Ô∏è –¶–µ–Ω–∞ —Å–µ–π—á–∞—Å: <b>15 251 250 ‚ÇΩ</b>
‚ñ™Ô∏è –î–æ—Ö–æ–¥ –æ—Ç –∞—Ä–µ–Ω–¥—ã: <b>~1 642 500 ‚ÇΩ/–≥–æ–¥</b> (10.8% –≥–æ–¥–æ–≤—ã—Ö)
‚ñ™Ô∏è –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥: <b>~137 000 ‚ÇΩ</b>

üìà <b>–ö–ê–ü–ò–¢–ê–õ–ò–ó–ê–¶–ò–Ø</b>

‚ñ™Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ 2027: <b>~23 487 000 ‚ÇΩ</b> (+8.2 –º–ª–Ω, +54%)
‚ñ™Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ 2029: <b>~28 419 000 ‚ÇΩ</b> (+13.2 –º–ª–Ω, +86%)

üõ° <b>–ì–ê–†–ê–ù–¢–ò–ò</b>

–†–∞–±–æ—Ç–∞–µ—Ç ¬´–∫–æ—Ç–ª–æ–≤–∞—è —Å–∏—Å—Ç–µ–º–∞¬ª: –¥–æ—Ö–æ–¥ –≤—Å–µ–≥–æ –æ—Ç–µ–ª—è —Å—É–º–º–∏—Ä—É–µ—Ç—Å—è –∏ —Ä–∞—Å–ø—Ä–µ–¥–µ–ª—è–µ—Ç—Å—è –º–µ–∂–¥—É —Å–æ–±—Å—Ç–≤–µ–Ω–Ω–∏–∫–∞–º–∏. –£—Å–ª–æ–≤–∏—è —Ñ–∏–∫—Å–∏—Ä—É—é—Ç—Å—è –≤ –¥–æ–≥–æ–≤–æ—Ä–µ —Å –£–ö.

üí≥ <b>–í–ê–†–ò–ê–ù–¢–´ –ü–û–ö–£–ü–ö–ò</b>

‚ñ™Ô∏è –†–∞—Å—Å—Ä–æ—á–∫–∞ –æ—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞: 12-18 –º–µ—Å, –ü–í –æ—Ç 30%, —Å—Ç–∞–≤–∫–∞ 0-9%
‚ñ™Ô∏è –ò–ø–æ—Ç–µ–∫–∞: –ª—å–≥–æ—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 4.4% –Ω–∞ –ø–µ—Ä–≤—ã–π –≥–æ–¥

‚ÑπÔ∏è –ë–æ–Ω—É—Å: –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ (—ç–∫–æ–Ω–æ–º–∏—è 150 000 ‚ÇΩ)

üí¨ –•–æ—Ç–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç? –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–∫–∞–∑¬ª.""",

    "B210": """üî• <b>–°—Ç–∞–Ω–¥–∞—Ä—Ç B210 (31.6 –º¬≤)</b>

<b>–í—ã–±–æ—Ä –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤ ‚Äî –±–∞–ª–∞–Ω—Å —Ü–µ–Ω—ã –∏ –Ω–∞–¥–µ–∂–Ω–æ—Å—Ç–∏</b>

–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –Ω–æ–º–µ—Ä, –≥–µ–Ω–µ—Ä–∏—Ä—É—é—â–∏–π —Å—Ç–∞–±–∏–ª—å–Ω—ã–π Cash Flow. –°–∞–º—ã–π –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —É —Ç—É—Ä–∏—Å—Ç–æ–≤.

üìä <b>–î–û–•–û–î–ù–û–°–¢–¨</b>

‚ñ™Ô∏è –¶–µ–Ω–∞ —Å–µ–π—á–∞—Å: <b>19 671 000 ‚ÇΩ</b>
‚ñ™Ô∏è –î–æ—Ö–æ–¥ –æ—Ç –∞—Ä–µ–Ω–¥—ã: <b>~1 861 500 ‚ÇΩ/–≥–æ–¥</b> (9.5% –≥–æ–¥–æ–≤—ã—Ö)
‚ñ™Ô∏è –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥: <b>~155 000 ‚ÇΩ</b>

üìà <b>–ö–ê–ü–ò–¢–ê–õ–ò–ó–ê–¶–ò–Ø</b>

‚ñ™Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ 2027: <b>~30 293 000 ‚ÇΩ</b> (+10.6 –º–ª–Ω, +54%)
‚ñ™Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ 2029: <b>~36 655 000 ‚ÇΩ</b> (+17 –º–ª–Ω, +86%)

üõ° <b>–ì–ê–†–ê–ù–¢–ò–ò</b>

–°–∏—Å—Ç–µ–º–∞ ¬´–û–±—â–∏–π –∫–æ—Ç—ë–ª¬ª ‚Äî –≤—ã –ø–æ–ª—É—á–∞–µ—Ç–µ –ø—Ä–∏–±—ã–ª—å, –¥–∞–∂–µ –µ—Å–ª–∏ –≤ –≤–∞—à–µ–º –Ω–æ–º–µ—Ä–µ —Å–µ–≥–æ–¥–Ω—è –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç. –ì–∞—Ä–∞–Ω—Ç–∏–∏ –ø—Ä–æ–ø–∏—Å–∞–Ω—ã –≤ –¥–æ–≥–æ–≤–æ—Ä–µ —Å –£–ö.

üí≥ <b>–í–ê–†–ò–ê–ù–¢–´ –ü–û–ö–£–ü–ö–ò</b>

‚ñ™Ô∏è –†–∞—Å—Å—Ä–æ—á–∫–∞ –æ—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞: 12-18 –º–µ—Å, –ü–í –æ—Ç 30%, —Å—Ç–∞–≤–∫–∞ 0-9%
‚ñ™Ô∏è –ò–ø–æ—Ç–µ–∫–∞: –ª—å–≥–æ—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 4.4% –Ω–∞ –ø–µ—Ä–≤—ã–π –≥–æ–¥

‚ÑπÔ∏è –ë–æ–Ω—É—Å: –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ (—ç–∫–æ–Ω–æ–º–∏—è 150 000 ‚ÇΩ)

üí¨ –•–æ—Ç–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç? –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–∫–∞–∑¬ª.""",

    "A305": """üëë <b>–õ—é–∫—Å A305 (38.8 –º¬≤)</b>

<b>–ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–π –∞–∫—Ç–∏–≤ ‚Äî –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –ø–æ—Ç–µ–Ω—Ü–∏–∞–ª —Ä–æ—Å—Ç–∞</b>

–î–µ—Ñ–∏—Ü–∏—Ç–Ω—ã–π —Å–µ–º–µ–π–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —Å —Å–∞–º—ã–º –≤—ã—Å–æ–∫–∏–º –∞–±—Å–æ–ª—é—Ç–Ω—ã–º –¥–æ—Ö–æ–¥–æ–º –∏ –∫–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏–µ–π.

üìä <b>–î–û–•–û–î–ù–û–°–¢–¨</b>

‚ñ™Ô∏è –¶–µ–Ω–∞ —Å–µ–π—á–∞—Å: <b>23 741 720 ‚ÇΩ</b>
‚ñ™Ô∏è –î–æ—Ö–æ–¥ –æ—Ç –∞—Ä–µ–Ω–¥—ã: <b>~2 299 500 ‚ÇΩ/–≥–æ–¥</b> (9.7% –≥–æ–¥–æ–≤—ã—Ö)
‚ñ™Ô∏è –ï–∂–µ–º–µ—Å—è—á–Ω—ã–π –¥–æ—Ö–æ–¥: <b>~192 000 ‚ÇΩ</b>

üìà <b>–ö–ê–ü–ò–¢–ê–õ–ò–ó–ê–¶–ò–Ø</b>

‚ñ™Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ 2027: <b>~36 562 000 ‚ÇΩ</b> (+12.8 –º–ª–Ω, +54%)
‚ñ™Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ 2029: <b>~44 240 000 ‚ÇΩ</b> (+20.5 –º–ª–Ω, +86%)

üõ° <b>–ì–ê–†–ê–ù–¢–ò–ò</b>

–ü—Ä–æ–∑—Ä–∞—á–Ω–∞—è ¬´–∫–æ—Ç–ª–æ–≤–∞—è –º–æ–¥–µ–ª—å¬ª –Ω–∞—á–∏—Å–ª–µ–Ω–∏—è –ø—Ä–∏–±—ã–ª–∏. –í—Å–µ –∏–Ω–≤–µ—Å—Ç–æ—Ä—ã –∑–∞—â–∏—â–µ–Ω—ã –æ—Ç –ø—Ä–æ—Å—Ç–æ—è –Ω–æ–º–µ—Ä–æ–≤. –ì–∞—Ä–∞–Ω—Ç–∏—Ä–æ–≤–∞–Ω–Ω—ã–π –¥–æ—Ö–æ–¥ –∑–∞—Ñ–∏–∫—Å–∏—Ä–æ–≤–∞–Ω –≤ –¥–æ–≥–æ–≤–æ—Ä–µ —Å –£–ö.

üí≥ <b>–í–ê–†–ò–ê–ù–¢–´ –ü–û–ö–£–ü–ö–ò</b>

‚ñ™Ô∏è –†–∞—Å—Å—Ä–æ—á–∫–∞ –æ—Ç –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫–∞: 12-18 –º–µ—Å, –ü–í –æ—Ç 30%, —Å—Ç–∞–≤–∫–∞ 0-9%
‚ñ™Ô∏è –ò–ø–æ—Ç–µ–∫–∞: –ª—å–≥–æ—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ 4.4% –Ω–∞ –ø–µ—Ä–≤—ã–π –≥–æ–¥

‚ÑπÔ∏è –ë–æ–Ω—É—Å: –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –≤–∫–ª—é—á–µ–Ω–æ (—ç–∫–æ–Ω–æ–º–∏—è 150 000 ‚ÇΩ)

üí¨ –•–æ—Ç–∏—Ç–µ –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á—ë—Ç? –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–∫–∞–∑¬ª."""
}

# –¢–µ–∫—Å—Ç—ã –¥–ª—è —Ä–∞—Å—Å—Ä–æ—á–∫–∏ –∏ –∏–ø–æ—Ç–µ–∫–∏
FINANCE_TEXTS = {
    "A209": """üíé <b>–°—Ç—É–¥–∏—è A209 (24.5 –º¬≤) ‚Äî –õ–µ–≥–∫–∏–π —Å—Ç–∞—Ä—Ç</b>

üëã <b>–í–∞—à –±–∏–ª–µ—Ç –≤ –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–∏: –ö–æ–º–ø–∞–∫—Ç–Ω—ã–π –∏ –ª–∏–∫–≤–∏–¥–Ω—ã–π –Ω–æ–º–µ—Ä</b>

–ò–¥–µ–∞–ª—å–Ω—ã–π –ª–æ—Ç –¥–ª—è –ø–µ—Ä–≤–æ–≥–æ –∞–∫—Ç–∏–≤–∞. –°–∞–º—ã–π –Ω–∏–∑–∫–∏–π –ø–æ—Ä–æ–≥ –≤—Ö–æ–¥–∞, –ø—Ä–∏ —ç—Ç–æ–º ‚Äî –ø–æ–ª–Ω–æ—Ü–µ–Ω–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –∏ –ª–∏–∫–≤–∏–¥–Ω–æ—Å—Ç—å –ø—Ä–∏ –ø–µ—Ä–µ–ø—Ä–æ–¥–∞–∂–µ.

üí∞ <b>–≠–∫–æ–Ω–æ–º–∏–∫–∞ –ª–æ—Ç–∞:</b>
‚ñ™Ô∏è –¶–µ–Ω–∞ —Å–µ–π—á–∞—Å: <b>15 251 250 ‚ÇΩ</b>
‚ñ™Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ —Ü–µ–Ω—ã (2027): <b>~23 487 000 ‚ÇΩ</b> (+54%)

‚ÑπÔ∏è <b>–ë–æ–Ω—É—Å:</b> –í —Ü–µ–Ω—É —É–∂–µ –≤–∫–ª—é—á–µ–Ω–æ –æ—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∏ —é—Ä–∏—Å—Ç—ã (—ç–∫–æ–Ω–æ–º–∏—è 150 000 ‚ÇΩ).

üëá <b>–ö–∞–∫ –∫—É–ø–∏—Ç—å? –í—ã–±–µ—Ä–∏—Ç–µ –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–π –ø–ª–∞—Ç–µ–∂:</b>

<b>1Ô∏è‚É£ ¬´–£–º–Ω–∞—è –∏–ø–æ—Ç–µ–∫–∞¬ª (–•–∏—Ç –ø—Ä–æ–¥–∞–∂ üî•)</b>
–ó–∞—Ö–æ–¥–∏—Ç–µ –≤ –∞–∫—Ç–∏–≤ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω–æ–π –Ω–∞–≥—Ä—É–∑–∫–æ–π –Ω–∞ –∫–æ—à–µ–ª–µ–∫ –≤ –ø–µ—Ä–≤—ã–π –≥–æ–¥.

- –ü–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å: ~4.3 –º–ª–Ω ‚ÇΩ
- –ü–ª–∞—Ç—ë–∂ –≤ –ø–µ—Ä–≤—ã–π –≥–æ–¥: –≤—Å–µ–≥–æ 54 519 ‚ÇΩ/–º–µ—Å (–õ—å–≥–æ—Ç–Ω–∞—è —Å—Ç–∞–≤–∫–∞ ~4.4%)
- <b>–°—É—Ç—å —Å—Ç—Ä–∞—Ç–µ–≥–∏–∏:</b> –ü–æ–∫–∞ –∏–¥–µ—Ç —Å—Ç—Ä–æ–π–∫–∞ –∏ –∞–∫—Ç–∏–≤ –¥–æ—Ä–æ–∂–∞–µ—Ç, –≤—ã –ø–ª–∞—Ç–∏—Ç–µ –∫–æ–ø–µ–π–∫–∏. –ö–æ–≥–¥–∞ –≤–∫–ª—é—á–∞–µ—Ç—Å—è –ø–æ–ª–Ω—ã–π –ø–ª–∞—Ç–µ–∂, –∞—Ä–µ–Ω–¥–∞ (~130–∫) –ø–æ–º–æ–≥–∞–µ—Ç –µ–≥–æ –≥–∞—Å–∏—Ç—å.

<b>2Ô∏è‚É£ –†–∞—Å—Å—Ä–æ—á–∫–∞ ¬´–ë–µ–∑ –ø–µ—Ä–µ–ø–ª–∞—Ç¬ª</b>
–î–ª—è —Ç–µ—Ö, –∫—Ç–æ —Ö–æ—á–µ—Ç –±—ã—Å—Ç—Ä–æ –∑–∞–∫—Ä—ã—Ç—å —Å–¥–µ–ª–∫—É.

- –ü–µ—Ä–≤—ã–π –≤–∑–Ω–æ—Å: 30% (4.5 –º–ª–Ω ‚ÇΩ)
- –£–¥–æ—Ä–æ–∂–∞–Ω–∏–µ: 0%
- –û—Å—Ç–∞—Ç–æ–∫: —Ä–∞–≤–Ω—ã–º–∏ –¥–æ–ª—è–º–∏ –∑–∞ 1 –≥–æ–¥.

<b>3Ô∏è‚É£ –†–∞—Å—Å—Ä–æ—á–∫–∞ ¬´–î–ª–∏–Ω–Ω–∞—è¬ª (18 –º–µ—Å)</b>

- –ü–í 30% + –Ω–µ–±–æ–ª—å—à–æ–µ —É–¥–æ—Ä–æ–∂–∞–Ω–∏–µ (4%).
- –†–∞—Å—Ç—è–≥–∏–≤–∞–µ–º –æ–ø–ª–∞—Ç—É –¥–æ —Å–¥–∞—á–∏ –æ–±—ä–µ–∫—Ç–∞.

üí¨ <b>–•–æ—Ç–∏—Ç–µ –≥—Ä–∞—Ñ–∏–∫ –ø–ª–∞—Ç–µ–∂–µ–π –ø–æ–¥ –≤–∞—à –±—é–¥–∂–µ—Ç?</b> –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–∫–∞–∑¬ª ‚Äî –º–µ–Ω–µ–¥–∂–µ—Ä —Å–¥–µ–ª–∞–µ—Ç –ø–µ—Ä—Å–æ–Ω–∞–ª—å–Ω—ã–π —Ä–∞—Å—á–µ—Ç –∑–∞ 5 –º–∏–Ω—É—Ç.""",

    "B210": """üî• <b>–°—Ç–∞–Ω–¥–∞—Ä—Ç B210 (31.6 –º¬≤) ‚Äî –ó–æ–ª–æ—Ç–∞—è —Å–µ—Ä–µ–¥–∏–Ω–∞</b>

üèÜ <b>–í—ã–±–æ—Ä –∏–Ω–≤–µ—Å—Ç–æ—Ä–æ–≤: –ú–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–π –±–∞–ª–∞–Ω—Å —Ü–µ–Ω—ã –∏ –∞—Ä–µ–Ω–¥—ã</b>

–ö–ª–∞—Å—Å–∏—á–µ—Å–∫–∏–π –≥–æ—Å—Ç–∏–Ω–∏—á–Ω—ã–π –Ω–æ–º–µ—Ä. –°–∞–º—ã–π –≤–æ—Å—Ç—Ä–µ–±–æ–≤–∞–Ω–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç —É —Ç—É—Ä–∏—Å—Ç–æ–≤, –∫–æ—Ç–æ—Ä—ã–π –≥–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç —Å—Ç–∞–±–∏–ª—å–Ω–æ –≤—ã—Å–æ–∫–∏–π –¥–µ–Ω–µ–∂–Ω—ã–π –ø–æ—Ç–æ–∫ (Cash Flow).

üí∞ <b>–≠–∫–æ–Ω–æ–º–∏–∫–∞ –ª–æ—Ç–∞:</b>
‚ñ™Ô∏è –¶–µ–Ω–∞ —Å–µ–π—á–∞—Å: <b>19 671 000 ‚ÇΩ</b>
‚ñ™Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ —Ü–µ–Ω—ã (2027): <b>~30 293 000 ‚ÇΩ</b> (+54%)

‚ÑπÔ∏è <b>–ë–æ–Ω—É—Å:</b> –û—Ñ–æ—Ä–º–ª–µ–Ω–∏–µ –∏ —é—Ä–∏—Å—Ç—ã –≤–∫–ª—é—á–µ–Ω—ã (—ç–∫–æ–Ω–æ–º–∏—è 150 000 ‚ÇΩ).

üëá <b>–í–∞—Ä–∏–∞–Ω—Ç—ã –ø–æ–∫—É–ø–∫–∏:</b>

<b>1Ô∏è‚É£ –ò–ø–æ—Ç–µ–∫–∞ —Å –ª—å–≥–æ—Ç–Ω—ã–º –ø–µ—Ä–∏–æ–¥–æ–º ‚ö°Ô∏è</b>
–ò—Å–ø–æ–ª—å–∑—É–π—Ç–µ –¥–µ–Ω—å–≥–∏ –±–∞–Ω–∫–∞, —á—Ç–æ–±—ã –∑–∞—Ä–∞–±–æ—Ç–∞—Ç—å –Ω–∞ —Ä–æ—Å—Ç–µ —Ü–µ–Ω.

- –í—Ö–æ–¥: ~5.6 –º–ª–Ω ‚ÇΩ
- –ü–µ—Ä–≤—ã–π –≥–æ–¥ –≤—ã –ø–ª–∞—Ç–∏—Ç–µ: 70 319 ‚ÇΩ/–º–µ—Å
- <b>–í–∞—à–∞ –≤—ã–≥–æ–¥–∞:</b> –ê–∫—Ç–∏–≤ —Ä–∞—Å—Ç–µ—Ç –Ω–∞ ~5 –º–ª–Ω –∑–∞ –≥–æ–¥, –∞ –≤—ã –ø–ª–∞—Ç–∏—Ç–µ –±–∞–Ω–∫—É –ø–æ —Å–Ω–∏–∂–µ–Ω–Ω–æ–π —Å—Ç–∞–≤–∫–µ. –° 2028 –≥–æ–¥–∞ –∞—Ä–µ–Ω–¥–∞ (~170–∫) –ø–µ—Ä–µ–∫—Ä—ã–≤–∞–µ—Ç –±–æ–ª—å—à—É—é —á–∞—Å—Ç—å –ø–ª–∞—Ç–µ–∂–∞.

<b>2Ô∏è‚É£ –†–∞—Å—Å—Ä–æ—á–∫–∞ 0% (–Ω–∞ 12 –º–µ—Å)</b>

- –í–Ω–æ—Å–∏–º 30% —Å–µ–π—á–∞—Å.
- –û—Å—Ç–∞—Ç–æ–∫ –¥–µ–ª–∏–º –Ω–∞ –≥–æ–¥ –±–µ–∑ –ø—Ä–æ—Ü–µ–Ω—Ç–æ–≤ –±–∞–Ω–∫—É.

<b>3Ô∏è‚É£ –†–∞—Å—Å—Ä–æ—á–∫–∞ ¬´–ò–Ω–≤–µ—Å—Ç–æ—Ä¬ª (–Ω–∞ 18 –º–µ—Å)</b>

- –ü–í 30% (5.9 –º–ª–Ω ‚ÇΩ).
- –§–∏–∫—Å–∏—Ä—É–µ–º —Ü–µ–Ω—É, –ø–ª–∞—Ç–∏–º –∫–æ–º—Ñ–æ—Ä—Ç–Ω—ã–º–∏ —á–∞—Å—Ç—è–º–∏ 2 –≥–æ–¥–∞.

<b>–õ–∞–π—Ñ—Ö–∞–∫:</b> –ï—Å–ª–∏ –≤–Ω–µ—Å—Ç–∏ 50% –ü–í, –º–æ–∂–Ω–æ –ø–ª–∞—Ç–∏—Ç—å —Ä–∞–∑ –≤ –∫–≤–∞—Ä—Ç–∞–ª, –∞ –Ω–µ –∫–∞–∂–¥—ã–π –º–µ—Å—è—Ü.

üí¨ <b>–ù–µ –∑–Ω–∞–µ—Ç–µ, —á—Ç–æ –≤—ã–≥–æ–¥–Ω–µ–µ: –∏–ø–æ—Ç–µ–∫–∞ –∏–ª–∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∞?</b> –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–∫–∞–∑¬ª ‚Äî –º—ã –ø—Ä–∏—à–ª–µ–º —Å—Ä–∞–≤–Ω–∏—Ç–µ–ª—å–Ω—É—é —Ç–∞–±–ª–∏—Ü—É –¥–ª—è —ç—Ç–æ–≥–æ –Ω–æ–º–µ—Ä–∞.""",

    "A305": """üëë <b>–õ—é–∫—Å A305 (38.8 –º¬≤) ‚Äî –ü—Ä–µ–º–∏—É–º –∞–∫—Ç–∏–≤</b>

üíé <b>–ü—Ä–µ–º–∏–∞–ª—å–Ω—ã–π –∞–∫—Ç–∏–≤: –°–µ–º–µ–π–Ω—ã–π –ª—é–∫—Å —Å –º–∞–∫—Å–∏–º–∞–ª—å–Ω—ã–º —Ä–æ—Å—Ç–æ–º</b>

–î–µ—Ñ–∏—Ü–∏—Ç–Ω—ã–π —Ñ–æ—Ä–º–∞—Ç. –¢–∞–∫–∏—Ö –Ω–æ–º–µ—Ä–æ–≤ –º–∞–ª–æ, –ø–æ—ç—Ç–æ–º—É –Ω–∞ –Ω–∏—Ö –≤—Å–µ–≥–¥–∞ –≤—ã—Å–æ–∫–∏–π —Å–ø—Ä–æ—Å –∏ —Å–∞–º–∞—è –¥–æ—Ä–æ–≥–∞—è –∞—Ä–µ–Ω–¥–∞ –≤ –ø–∏–∫–æ–≤—ã–µ —Å–µ–∑–æ–Ω—ã. –õ—É—á—à–∏–π –≤–∞—Ä–∏–∞–Ω—Ç –¥–ª—è —Å–æ–∑–¥–∞–Ω–∏—è —Å–µ–º–µ–π–Ω–æ–≥–æ –∫–∞–ø–∏—Ç–∞–ª–∞.

üí∞ <b>–≠–∫–æ–Ω–æ–º–∏–∫–∞ –ª–æ—Ç–∞:</b>
‚ñ™Ô∏è –¶–µ–Ω–∞ —Å–µ–π—á–∞—Å: <b>23 741 720 ‚ÇΩ</b>
‚ñ™Ô∏è –ü—Ä–æ–≥–Ω–æ–∑ —Ü–µ–Ω—ã (2027): <b>~36 562 000 ‚ÇΩ</b>

‚ÑπÔ∏è <b>–ü–æ–¥–∞—Ä–æ–∫:</b> –ü–∞–∫–µ—Ç ¬´–õ–µ–≥–∫–∏–π –≤—Ö–æ–¥¬ª (–±—Ä–æ–Ω—å + –¥–æ–≥–æ–≤–æ—Ä) –Ω–∞ 150 000 ‚ÇΩ —É–∂–µ –≤ —Ü–µ–Ω–µ.

üëá <b>–ò–Ω—Å—Ç—Ä—É–º–µ–Ω—Ç—ã –ø–æ–∫—É–ø–∫–∏:</b>

<b>1Ô∏è‚É£ –ò–ø–æ—Ç–µ–∫–∞ ¬´–£–º–Ω—ã–π —Ä—ã—á–∞–≥¬ª üöÄ</b>
–ó–∞–±–∏—Ä–∞–µ–º —Ç–æ–ø–æ–≤—ã–π –∞–∫—Ç–∏–≤ —Å –ø–ª–∞—Ç–µ–∂–æ–º –ø–æ —Ü–µ–Ω–µ –æ–±—ã—á–Ω–æ–π "–æ–¥–Ω—É—à–∫–∏".

- –í—Ö–æ–¥: ~6.7 –º–ª–Ω ‚ÇΩ
- –õ—å–≥–æ—Ç–Ω—ã–π –ø–µ—Ä–∏–æ–¥ (1 –≥–æ–¥): 84 871 ‚ÇΩ/–º–µ—Å
- <b>–ú–∞—Ç–µ–º–∞—Ç–∏–∫–∞:</b> –í—ã –≤–ª–∞–¥–µ–µ—Ç–µ –∞–∫—Ç–∏–≤–æ–º –∑–∞ 23 –º–ª–Ω, –≤–∫–ª–∞–¥—ã–≤–∞—è –º–∏–Ω–∏–º—É–º —Å–≤–æ–∏—Ö —Å—Ä–µ–¥—Å—Ç–≤. –ö 2029 –≥–æ–¥—É —ç—Ç–æ—Ç –ª–æ—Ç –±—É–¥–µ—Ç —Å—Ç–æ–∏—Ç—å –±–æ–ª–µ–µ 44 –º–ª–Ω ‚ÇΩ.

<b>2Ô∏è‚É£ –î–ª–∏–Ω–Ω–∞—è —Ä–∞—Å—Å—Ä–æ—á–∫–∞ (18 –º–µ—Å)</b>

- –í—Ö–æ–¥ 30% (7.1 –º–ª–Ω ‚ÇΩ).
- –£–¥–æ—Ä–æ–∂–∞–Ω–∏–µ –≤—Å–µ–≥–æ 6%.
- –ü–ª–∞—Ç–∏—Ç–µ –Ω–∞–ø—Ä—è–º—É—é –∑–∞—Å—Ç—Ä–æ–π—â–∏–∫—É, –±–µ–∑ —Å—Ç—Ä–∞—Ö–æ–≤–æ–∫ –∏ —Å–ø—Ä–∞–≤–æ–∫ –æ –¥–æ—Ö–æ–¥–∞—Ö.

<b>3Ô∏è‚É£ –ò–Ω–¥–∏–≤–∏–¥—É–∞–ª—å–Ω—ã–π –≥—Ä–∞—Ñ–∏–∫ (–æ—Ç 50% –ü–í)</b>

- –°–Ω–∏–∂–∞–µ–º —É–¥–æ—Ä–æ–∂–∞–Ω–∏–µ –¥–æ 3%.
- –ü–ª–∞—Ç–µ–∂–∏ –µ–∂–µ–∫–≤–∞—Ä—Ç–∞–ª—å–Ω–æ ‚Äî –∏–¥–µ–∞–ª—å–Ω–æ –¥–ª—è —Ç–µ—Ö, –∫—Ç–æ –∂–¥–µ—Ç –¥–∏–≤–∏–¥–µ–Ω–¥–æ–≤ –∏–ª–∏ –ø—Ä–æ–¥–∞–∂–∏ –¥—Ä—É–≥–∏—Ö –∞–∫—Ç–∏–≤–æ–≤.

üí¨ <b>–•–æ—Ç–∏—Ç–µ —É–≤–∏–¥–µ—Ç—å –ø–æ–ª–Ω—É—é —Ñ–∏–Ω–º–æ–¥–µ–ª—å —Å —Ä–∞—Å—á–µ—Ç–æ–º –æ–∫—É–ø–∞–µ–º–æ—Å—Ç–∏?</b> –ù–∞–∂–º–∏—Ç–µ ¬´–ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–∫–∞–∑¬ª ‚Äî —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º –≤ –æ–¥–∏–Ω –∫–ª–∏–∫ üëá"""
}


# ====== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ ROI ======

async def handle_base_roi(chat_id: int, unit_code: Optional[str] = None):
    """
    üìä –†–µ–Ω—Ç–∞–±–µ–ª—å–Ω–æ—Å—Ç—å/–¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å ‚Äî —Å –∞–∫—Ü–µ–Ω—Ç–æ–º –Ω–∞ –≥–∞—Ä–∞–Ω—Ç–∏–∏.
    """
    try:
        code = normalize_unit_code(unit_code) if unit_code else "A209"
        
        text = ROI_TEXTS.get(code)
        if not text:
            await send_message(chat_id, f"‚ö†Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —é–Ω–∏—Ç—É {code} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
            return
        
        inline_buttons = [
            [{"text": "üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–∫–∞–∑", "callback_data": "online_show"}]
        ]
        
        await send_message_inline(chat_id, text, inline_buttons)
    
    except Exception as e:
        await send_message(chat_id, f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏: {e}")


async def handle_unit_roi(chat_id: int, unit_code: str):
    """
    üìä –†–∞—Å—á—ë—Ç –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –ø–æ –∫–æ–Ω–∫—Ä–µ—Ç–Ω–æ–º—É —é–Ω–∏—Ç—É ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏–π —Ä–∞—Å—á—ë—Ç.
    """
    try:
        finance = load_finance()
        if not finance:
            await send_message(chat_id, "‚ö†Ô∏è –§–∏–Ω–∞–Ω—Å–æ–≤—ã–µ –ø–∞—Ä–∞–º–µ—Ç—Ä—ã –ø—Ä–æ–µ–∫—Ç–∞ –Ω–µ –Ω–∞–π–¥–µ–Ω—ã.")
            return
        
        code = normalize_unit_code(unit_code)
        unit = get_unit_by_code(finance, code)
        if not unit:
            await send_message(chat_id, f"‚ö†Ô∏è –ù–µ –Ω–∞–π–¥–µ–Ω —é–Ω–∏—Ç {code} –≤ –∫–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏.")
            return
        
        defaults = get_finance_defaults(finance)
        min_lot = get_min_lot(finance)
        entry_ratio = get_entry_ratio(finance)
        
        price = float(unit.get("price_rub", 0) or 0)
        entry_point = price * entry_ratio
        
        # –ê—Ä–µ–Ω–¥–∞
        rent = compute_rent_cashflow(unit, defaults)
        
        # –ü—Ä–æ–≥–Ω–æ–∑ —Ä–æ—Å—Ç–∞
        cap_block = unit.get("capitalization_projection", {}) or {}
        growth_rows = cap_block.get("total_return_pct_by_year", []) or []
        growth_lines = format_growth_projection(entry_point, growth_rows)
        
        extra_notes = finance.get("extra_notes", {}) or {}
        included_note = extra_notes.get("included_fees_note")
        
        lines: List[str] = []
        lines.append(f"üìä <b>–†–∞—Å—á–µ—Ç –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –ø–æ –≥–æ—Å—Ç–∏–Ω–∏—á–Ω–æ–º—É –Ω–æ–º–µ—Ä—É {code}</b>\n")
        
        area_m2 = unit.get("area_m2")
        if area_m2:
            lines.append(f"üè° –ü–ª–æ—â–∞–¥—å: {area_m2} –º¬≤")
        
        lines.append(f"‚Ä¢ –¶–µ–Ω–∞ –ø–æ –¥–æ–≥–æ–≤–æ—Ä—É: {fmt_rub(price)}")
        lines.append(
            f"‚Ä¢ –û—Ü–µ–Ω–æ—á–Ω–∞—è —Ç–æ—á–∫–∞ –≤—Ö–æ–¥–∞: {fmt_rub(entry_point)} "
            f"(–ø–æ –∞–Ω–∞–ª–æ–≥–∏–∏ —Å –º–∏–Ω–∏–º–∞–ª—å–Ω—ã–º –ª–æ—Ç–æ–º {min_lot.get('unit_code', 'A209')})"
        )
        
        # –ê—Ä–µ–Ω–¥–Ω—ã–π –ø–æ—Ç–æ–∫
        lines.append("\nüè® <b>–ê—Ä–µ–Ω–¥–Ω—ã–π –ø–æ—Ç–æ–∫ (—É–ø—Ä–æ—â–µ–Ω–Ω—ã–π —Å—Ü–µ–Ω–∞—Ä–∏–π)</b>")
        daily_rate = unit.get('daily_rate_rub') or defaults.get('daily_rate_rub', 0)
        occ = unit.get('occupancy_pct') or defaults.get('occupancy_pct', 0)
        exp = unit.get('expenses_pct') or defaults.get('expenses_pct', 0)
        
        lines.append(
            f"‚Ä¢ –ë–∞–∑–æ–≤–∞—è —Å—Ç–∞–≤–∫–∞: {fmt_rub(daily_rate)}/—Å—É—Ç–∫–∏\n"
            f"‚Ä¢ –°—Ä–µ–¥–Ω—è—è –∑–∞–≥—Ä—É–∑–∫–∞: {occ}% –≤ –≥–æ–¥\n"
            f"‚Ä¢ –û–ø–µ—Ä–∞—Ü–∏–æ–Ω–Ω—ã–µ —Ä–∞—Å—Ö–æ–¥—ã: {exp}% –æ—Ç –≤—ã—Ä—É—á–∫–∏"
        )
        lines.append(
            f"‚Ä¢ –í–∞–ª–æ–≤–∞—è –≤—ã—Ä—É—á–∫–∞ –≤ –≥–æ–¥: ~{fmt_rub(rent['gross_year_rub'])}\n"
            f"‚Ä¢ –ß–∏—Å—Ç—ã–π –¥–æ—Ö–æ–¥ –≤ –≥–æ–¥ –ø–æ—Å–ª–µ —Ä–∞—Å—Ö–æ–¥–æ–≤: ~{fmt_rub(rent['net_year_rub'])}\n"
            f"‚Ä¢ –î–æ—Ö–æ–¥–Ω–æ—Å—Ç—å –ø–æ –∞—Ä–µ–Ω–¥–µ: ~{rent['roi_year_pct']:.2f}% –≥–æ–¥–æ–≤—ã—Ö –æ—Ç–Ω–æ—Å–∏—Ç–µ–ª—å–Ω–æ —Ü–µ–Ω—ã."
        )
        
        # –ö–∞–ø–∏—Ç–∞–ª–∏–∑–∞—Ü–∏—è
        if growth_lines:
            lines.append("\nüìà <b>–†–æ—Å—Ç —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –∏ –∫–∞–ø–∏—Ç–∞–ª –ø–æ –≥–æ–¥–∞–º</b>")
            lines.append(
                "–ü–æ –∏–Ω–≤–µ—Å—Ç-—Ä–∞—Å—á–µ—Ç—É –≤—ã –∑–∞—Ä–∞–±–∞—Ç—ã–≤–∞–µ—Ç–µ –Ω–µ —Ç–æ–ª—å–∫–æ –Ω–∞ –∞—Ä–µ–Ω–¥–µ, "
                "–Ω–æ –∏ –Ω–∞ —Ä–æ—Å—Ç–µ —Å—Ç–æ–∏–º–æ—Å—Ç–∏ –≥–æ—Å—Ç–∏–Ω–∏—á–Ω–æ–≥–æ –Ω–æ–º–µ—Ä–∞."
            )
            lines.append("–ü—Ä–æ–≥–Ω–æ–∑ –ø–æ –≥–æ–¥–∞–º (–∫–∞–ø–∏—Ç–∞–ª –∏ —Å–æ–≤–æ–∫—É–ø–Ω–∞—è –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç—å):")
            lines.extend(growth_lines)
        
        if included_note:
            lines.append("")
            lines.append(f"‚ÑπÔ∏è {included_note}")
        
        lines.append(
            "\n–ï—Å–ª–∏ —Ö–æ—Ç–∏—Ç–µ, –º–æ–≥—É —Å—Ä–∞–≤–Ω–∏—Ç—å —ç—Ç–æ—Ç –≥–æ—Å—Ç–∏–Ω–∏—á–Ω—ã–π –Ω–æ–º–µ—Ä —Å –¥—Ä—É–≥–∏–º–∏ –≤–∞—Ä–∏–∞–Ω—Ç–∞–º–∏ "
            "–∏–ª–∏ –ø—Ä–µ–¥–ª–æ–∂–∏—Ç—å –ø–æ—Ä—Ç—Ñ–µ–ª—å –ø–æ–¥ –≤–∞—à –±—é–¥–∂–µ—Ç (–Ω–µ—Å–∫–æ–ª—å–∫–æ –ª–æ—Ç–æ–≤)."
        )
        
        await send_message(chat_id, "\n".join(lines))
    
    except Exception as e:
        await send_message(chat_id, f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ä–∞—Å—á–µ—Ç–µ –¥–æ—Ö–æ–¥–Ω–æ—Å—Ç–∏ –ø–æ —é–Ω–∏—Ç—É: {e}")


# ====== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∏/–∏–ø–æ—Ç–µ–∫–∏ ======

async def handle_finance_overview(chat_id: int, unit_code: Optional[str] = None):
    """
    üí≥ –†–∞—Å—Å—Ä–æ—á–∫–∞ –∏ –∏–ø–æ—Ç–µ–∫–∞ ‚Äî –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è –∏–∑ JSON.
    """
    try:
        code = normalize_unit_code(unit_code) if unit_code else "A209"
        
        # –ó–∞–≥—Ä—É–∂–∞–µ–º –¥–∞–Ω–Ω—ã–µ –∏–∑ JSON
        finance = load_finance()
        if not finance:
            # Fallback –Ω–∞ –∑–∞—Ö–∞—Ä–¥–∫–æ–∂–µ–Ω–Ω—ã–µ —Ç–µ–∫—Å—Ç—ã
            text = FINANCE_TEXTS.get(code)
            if not text:
                await send_message(chat_id, f"‚ö†Ô∏è –ò–Ω—Ñ–æ—Ä–º–∞—Ü–∏—è –ø–æ —é–Ω–∏—Ç—É {code} –Ω–µ –Ω–∞–π–¥–µ–Ω–∞.")
                return
        else:
            # –î–∏–Ω–∞–º–∏—á–µ—Å–∫–∞—è –≥–µ–Ω–µ—Ä–∞—Ü–∏—è
            text = generate_finance_text(code, finance)
        
        inline_buttons = [
            [{"text": "üìÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–∫–∞–∑", "callback_data": "online_show"}]
        ]
        
        await send_message_inline(chat_id, text, inline_buttons)
    
    except Exception as e:
        await send_message(chat_id, f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ —Ñ–æ—Ä–º–∏—Ä–æ–≤–∞–Ω–∏–∏ —Ä–∞—Å—Å—Ä–æ—á–∫–∏ –∏ –∏–ø–æ—Ç–µ–∫–∏: {e}")


# ====== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–ª–∞–Ω–∏—Ä–æ–≤–æ–∫ ======

async def handle_layouts(chat_id: int, unit_code: Optional[str] = None):
    """
    –û—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PDF-–ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏.
    """
    layouts_dir = RIZALTA_LAYOUTS_DIR
    
    if not os.path.exists(layouts_dir):
        await send_message(chat_id, "–ü–∞–ø–∫–∞ —Å –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∞–º–∏ –Ω–µ –Ω–∞–π–¥–µ–Ω–∞ –Ω–∞ —Å–µ—Ä–≤–µ—Ä–µ.")
        return
    
    # –°–æ–±–∏—Ä–∞–µ–º PDF
    files = sorted([f for f in os.listdir(layouts_dir) if f.lower().endswith(".pdf")])
    
    if not files:
        await send_message(chat_id, "–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏ –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω—ã.")
        return
    
    # –§–∏–ª—å—Ç—Ä—É–µ–º –ø–æ —é–Ω–∏—Ç—É
    if unit_code:
        normalized_code = normalize_unit_code(unit_code)
        filtered = []
        for f in files:
            normalized_filename = normalize_unit_code(f)
            if normalized_code in normalized_filename:
                filtered.append(f)
        
        if not filtered:
            await send_message(chat_id, f"–ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –¥–ª—è {unit_code} –ø–æ–∫–∞ –Ω–µ –∑–∞–≥—Ä—É–∂–µ–Ω–∞.")
            return
        files = filtered
    
    await send_message(chat_id, "üìé –û—Ç–ø—Ä–∞–≤–ª—è—é –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–∏...")
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º –¥–æ–∫—É–º–µ–Ω—Ç—ã
    from config.settings import TELEGRAM_BOT_TOKEN
    token = TELEGRAM_BOT_TOKEN
    
    for filename in files:
        filepath = os.path.join(layouts_dir, filename)
        try:
            with open(filepath, "rb") as f:
                url = f"https://api.telegram.org/bot{token}/sendDocument"
                response = requests.post(
                    url,
                    data={"chat_id": chat_id},
                    files={"document": (filename, f, "application/pdf")},
                    timeout=60,
                )
                print(f"[TG] sendDocument {filename} status={response.status_code}")
        except Exception as e:
            print(f"[TG] Error sending {filename}: {e}")
            await send_message(chat_id, f"‚ö†Ô∏è –û—à–∏–±–∫–∞ –ø—Ä–∏ –æ—Ç–ø—Ä–∞–≤–∫–µ —Ñ–∞–π–ª–∞ {filename}")
    
    # Inline-–∫–Ω–æ–ø–∫–∏ –ø–æ—Å–ª–µ –æ—Ç–ø—Ä–∞–≤–∫–∏
    if unit_code:
        inline_buttons = [
            [
                {"text": "üìä –ü–æ–ª—É—á–∏—Ç—å —Ä–∞—Å—á–µ—Ç –ø–æ –ø–ª–∞–Ω–∏—Ä–æ–≤–∫–µ", "callback_data": f"roi_{unit_code}"},
                {"text": "üìû –í—ã–∑–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞", "callback_data": "call_manager"}
            ]
        ]
    else:
        inline_buttons = [
            [{"text": "üìû –í—ã–∑–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞", "callback_data": "call_manager"}]
        ]
    
    await send_message_inline(chat_id, "‚úÖ –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∞ –æ—Ç–ø—Ä–∞–≤–ª–µ–Ω–∞!", inline_buttons)


# ====== –û–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –ø–æ–¥–±–æ—Ä–∞ –ª–æ—Ç–∞ ======

async def handle_select_lot(chat_id: int):
    """
    üéØ –ù–∞—á–∞–ª–æ –ø–æ–¥–±–æ—Ä–∞ –ª–æ—Ç–∞ ‚Äî —Å–ø—Ä–∞—à–∏–≤–∞–µ–º –±—é–¥–∂–µ—Ç.
    """
    set_dialog_state(chat_id, DialogStates.CHOOSE_UNIT_ASK_BUDGET)
    
    await send_message(
        chat_id,
        "–î–∞–≤–∞–π—Ç–µ —Å–æ–∑–¥–∞–¥–∏–º –í–∞—à –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–æ—Ä—Ç—Ñ–µ–ª—å. üí°\n\n"
        "–ù–∞ –∫–∞–∫–æ–π –±—é–¥–∂–µ—Ç –æ—Ä–∏–µ–Ω—Ç–∏—Ä—É–µ—Ç–µ—Å—å? –ù–∞–ø–∏—à–∏—Ç–µ —Å—É–º–º—É –≤ —Ä—É–±–ª—è—Ö, "
        "–Ω–∞–ø—Ä–∏–º–µ—Ä: <b>20000000</b>.",
    )


async def handle_budget_input(chat_id: int, text: str):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ –±—é–¥–∂–µ—Ç–∞.
    """
    cleaned = "".join(ch for ch in text if ch.isdigit())
    if not cleaned:
        await send_message(
            chat_id,
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –≤–≤–µ–¥–∏—Ç–µ –±—é–¥–∂–µ—Ç —Ü–∏—Ñ—Ä–∞–º–∏, –Ω–∞–ø—Ä–∏–º–µ—Ä: <b>20000000</b>.",
        )
        return
    
    budget = int(cleaned)
    save_budget(chat_id, budget)
    
    # –°—Ä–∞–∑—É –ø–æ–∫–∞–∑—ã–≤–∞–µ–º —é–Ω–∏—Ç—ã (–±–µ–∑ –≤–æ–ø—Ä–æ—Å–∞ –ø—Ä–æ —Ñ–æ—Ä–º–∞—Ç)
    reply_text = suggest_units_for_budget(budget, "—Ä–∞—Å—Å—Ä–æ—á–∫–∞")
    clear_dialog_state(chat_id)
    
    inline_buttons = [
        [
            {"text": "üìÑ –°–∫–∞—á–∞—Ç—å PDF", "callback_data": "download_pdf"},
            {"text": "üìé –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏", "callback_data": "get_layouts"},
        ],
        [
            {"text": "‚úÖ –ó–∞–ø–∏—Å–∞—Ç—å—Å—è –Ω–∞ –æ–Ω–ª–∞–π–Ω-–ø–æ–∫–∞–∑", "callback_data": "online_show"}
        ]
    ]
    
    await send_message_inline(chat_id, reply_text, inline_buttons)


async def handle_format_input(chat_id: int, text: str):
    """
    –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤–≤–æ–¥–∞ —Ñ–æ—Ä–º–∞—Ç–∞ –æ–ø–ª–∞—Ç—ã.
    """
    fmt_text = text.lower()
    if "–∏–ø–æ—Ç–µ–∫" in fmt_text:
        preferred_format = "–∏–ø–æ—Ç–µ–∫–∞"
    elif "—Ä–∞—Å—Å—Ä–æ—á" in fmt_text:
        preferred_format = "—Ä–∞—Å—Å—Ä–æ—á–∫–∞"
    else:
        await send_message(
            chat_id,
            "–ü–æ–∂–∞–ª—É–π—Å—Ç–∞, –Ω–∞–ø–∏—à–∏—Ç–µ –æ–¥–Ω–æ —Å–ª–æ–≤–æ: <b>–∏–ø–æ—Ç–µ–∫–∞</b> –∏–ª–∏ <b>—Ä–∞—Å—Å—Ä–æ—á–∫–∞</b>.",
        )
        return
    
    save_format(chat_id, preferred_format)
    budget = get_budget(chat_id)
    
    if not budget:
        clear_dialog_state(chat_id)
        await send_message(
            chat_id,
            "–î–∞–≤–∞–π—Ç–µ –Ω–∞—á–Ω—ë–º –ø–æ–¥–±–æ—Ä –∑–∞–Ω–æ–≤–æ: –Ω–∞–∂–º–∏—Ç–µ –∫–Ω–æ–ø–∫—É ¬´–ü–æ–¥–æ–±—Ä–∞—Ç—å –ª–æ—Ç¬ª –∏ —É–∫–∞–∂–∏—Ç–µ –±—é–¥–∂–µ—Ç –µ—â—ë —Ä–∞–∑.",
            with_keyboard=True,
            buttons=MAIN_MENU_BUTTONS,
        )
        return
    
    reply_text = suggest_units_for_budget(budget, preferred_format)
    clear_dialog_state(chat_id)
    
    inline_buttons = [
        [
            {"text": "üìé –ü–ª–∞–Ω–∏—Ä–æ–≤–∫–∏", "callback_data": "get_layouts"},
            {"text": "üî• –í—ã–∑–≤–∞—Ç—å –º–µ–Ω–µ–¥–∂–µ—Ä–∞", "callback_data": "call_manager"}
        ]
    ]
    
    await send_message_inline(chat_id, reply_text, inline_buttons)


async def handle_download_pdf(chat_id: int, username: str = ""):
    """
    –ì–µ–Ω–µ—Ä–∏—Ä—É–µ—Ç –∏ –æ—Ç–ø—Ä–∞–≤–ª—è–µ—Ç PDF —Å –∏–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–º –ø–ª–∞–Ω–æ–º.
    """
    import os
    
    budget = get_budget(chat_id)
    
    if not budget:
        await send_message(
            chat_id,
            "–°–Ω–∞—á–∞–ª–∞ —É–∫–∞–∂–∏—Ç–µ –≤–∞—à –±—é–¥–∂–µ—Ç —á–µ—Ä–µ–∑ –∫–Ω–æ–ø–∫—É ¬´üéØ –ü–æ–¥–æ–±—Ä–∞—Ç—å –ª–æ—Ç¬ª.",
        )
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Å–æ–æ–±—â–µ–Ω–∏–µ –æ –≥–µ–Ω–µ—Ä–∞—Ü–∏–∏
    await send_message(chat_id, "‚è≥ –ì–µ–Ω–µ—Ä–∏—Ä—É—é PDF...")
    
    # –ì–µ–Ω–µ—Ä–∏—Ä—É–µ–º PDF
    filepath = generate_investment_pdf(budget, chat_id, username)
    
    if not filepath or not os.path.exists(filepath):
        await send_message(
            chat_id,
            "–ù–µ —É–¥–∞–ª–æ—Å—å —Å–≥–µ–Ω–µ—Ä–∏—Ä–æ–≤–∞—Ç—å PDF. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ –∏–ª–∏ —Å–≤—è–∂–∏—Ç–µ—Å—å —Å –º–µ–Ω–µ–¥–∂–µ—Ä–æ–º.",
        )
        return
    
    # –û—Ç–ø—Ä–∞–≤–ª—è–µ–º —Ñ–∞–π–ª
    caption = f"üìÑ –ò–Ω–≤–µ—Å—Ç–∏—Ü–∏–æ–Ω–Ω—ã–π –ø–ª–∞–Ω RIZALTA\n–ë—é–¥–∂–µ—Ç: {fmt_rub(budget)}"
    success = await send_document(chat_id, filepath, caption)
    
    # –£–¥–∞–ª—è–µ–º –≤—Ä–µ–º–µ–Ω–Ω—ã–π —Ñ–∞–π–ª
    try:
        os.remove(filepath)
    except Exception:
        pass
    
    if not success:
        await send_message(
            chat_id,
            "–ù–µ —É–¥–∞–ª–æ—Å—å –æ—Ç–ø—Ä–∞–≤–∏—Ç—å —Ñ–∞–π–ª. –ü–æ–ø—Ä–æ–±—É–π—Ç–µ –ø–æ–∑–∂–µ.",
        )
